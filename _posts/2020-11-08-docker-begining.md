---
layout: post
title:  "docker åˆæˆ°ç­†è¨˜"
date:   2020-11-07 15:00:13 +0800
category: deploy
img: cover/docker.jpg
description: ä¸€ç›´éƒ½æœ‰è½é docker è·Ÿå®¹å™¨åŒ–çš„æŠ€è¡“ï¼Œä½†ä¸€ç›´éƒ½æ²’æœ‰æ©Ÿæœƒç¢°åˆ°ï¼Œæœ€è¿‘ä¹Ÿæ˜¯å·¥ä½œé—œä¿‚é–‹å§‹æ¥è§¸åˆ°ï¼Œä¸€äº›è§€å¿µè·Ÿæ“ä½œéƒ½é‚„ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œè¶•å¿«å…ˆæŠŠæ‰€çŸ¥å…ˆç´€éŒ„ä¸€ä¸‹
lang: zh-TW
tags: [docker, deploy]
---

{{page.description}}

## å®‰è£
é¦–å…ˆå°±è«‹å…ˆåˆ° [docker å®˜ç¶²](https://www.docker.com/){:target="_blank"} å»ä¸‹è¼‰ä¸¦å®‰è£ï¼Œå®‰è£å®Œæ‡‰è©²è¦é‡å•Ÿï¼Œå¯èƒ½é‚„æœƒç™¼ç”Ÿä¸€äº›å•é¡Œè¦è£æ±è£è¥¿çš„ï¼Œå°±ç…§æŒ‡ç¤ºä¸€æ­¥ä¸€æ­¥å®Œæˆå§  

å®‰è£å®Œæˆå•Ÿå‹•å¾Œæœƒçœ‹åˆ°é€™å€‹ç•«é¢ï¼Œå·¥å…·åˆ—å³ä¸‹è§’é‚„æœ‰å¯æ„›çš„é¯¨é­š  
![](https://i.imgur.com/2GRGiA4.png)

## ç°¡ä»‹
Docker çš„æ¦‚å¿µå°±æ˜¯å‰µé€ ä¸€å€‹è™›æ“¬åŒ–çš„å®¹å™¨ï¼Œé€™å€‹å®¹å™¨åŒ…å«æ•´å€‹åŸ·è¡Œç’°å¢ƒï¼Œå¯ä»¥å¹«åŠ©ç”¢å“é–‹ç™¼å®Œæˆå¾Œéƒ¨å±¬åˆ°æ©Ÿå™¨ä¸Šä¸æ‰£å…¶ä»–ç’°å¢ƒçš„æ±¡æŸ“ï¼Œå¯ä»¥é‹è¡Œåœ¨ç¨ç«‹ä¸”ä¹¾æ·¨çš„ä¸€å€‹ç’°å¢ƒä¹‹ä¸‹ï¼Œç¢ºä¿é–‹ç™¼å®Œæˆçš„ç”¢å“åœ¨å¯é æœŸçš„ç©ºé–“ä¹‹ä¸‹åŸ·è¡Œ  

ä¹Ÿå¯ä»¥æ­é… Docker compose å’Œ K8s åšåˆ° container çš„ç®¡ç†é‚„æœ‰è‡ªå‹•åŒ–æ“ä½œï¼Œä¸éé‚£æ˜¯å¾Œè©±äº†ï¼Œç­†è€…ä¹Ÿåªæ¥è§¸éä¸€é»é»è€Œå·²ï¼Œé€™é‚Šå°±å…ˆç°¡å–®ç­†è¨˜ä¸€ä¸‹ docker çš„åŸºæœ¬æ¦‚å¿µèˆ‡æ“ä½œ

## é‹ä½œç°¡ä»‹
å°±å¦‚å‰é¢æ‰€èªªçš„ï¼ŒDocker çš„é‹ä½œå–®ä½æ˜¯ **Container**ï¼Œå¯ä»¥æƒ³åƒæˆå°±æ˜¯ä¸€å€‹è¼•é‡å‹çš„è™›æ“¬æ©Ÿï¼Œè€Œè·Ÿä¸€èˆ¬çš„æ©Ÿå™¨ä¸€æ¨£ï¼Œä½ å¯ä»¥å¾é ­å»ºç½®ä½ çš„ç’°å¢ƒï¼Œå¾çŒ OS é–‹å§‹ç„¶å¾ŒçŒä½ è¦çš„å·¥å…·ï¼Œè¨­å®šç’°å¢ƒè®Šæ•¸...ç­‰ç­‰  

ä½†å¦‚æœæ¯æ¬¡éƒ½è¦å»ºç½®ä¸€å€‹ç’°å¢ƒæœ‰é»å¤ªéº»ç…©äº†ï¼Œæ‰€ä»¥ container å…¶å¯¦å¯ä»¥å¥—ç”¨åˆ¥äººå·²ç¶“åšå¥½çš„æ¨¡æ¿ä¾†ç”¨ï¼Œå¯ä»¥å¹«ä½ å»ºç½® OSã€é–‹ç™¼ç’°å¢ƒã€é–‹ç™¼å·¥å…·.. éƒ½å¹«ä½ å…§å»ºåœ¨è£¡é¢äº†ï¼Œä½ åªéœ€è¦å†æŠŠä½ çš„ç”¢å“ä¸Ÿé€²å»å°±å¥½äº†ï¼Œè€Œé€™å€‹æ¨¡æ¿ï¼Œå°±è¢«ç¨±ç‚º **Image**  

## Image
Image ä½œç‚º Container çš„æ¨¡æ¿å­˜åœ¨ï¼Œå¤§æ¦‚æœ‰ä¸‹é¢ä¸‰ç¨®å–å¾—æ–¹æ³•:  
1. å¯« DockerFile ç„¶å¾Œä¸‹æŒ‡ä»¤ build image
2. æ‰“åŒ…æ—¢æœ‰çš„ container æˆ image
3. å¾ [Docker Hub](https://hub.docker.com/){:target="_blank"} ä¸Šæ‹‰åˆ¥äººå»ºå¥½çš„ image ä¸‹ä¾†ç”¨

ä¸€é–‹å§‹é€šå¸¸éƒ½æ˜¯å¾ Docker Hub ä¸Šæ‹‰ä¸€äº›åŸºæœ¬æ¬¾ä¸‹ä¾†ï¼Œç„¶å¾ŒçŒæˆè‡ªå·±ç¿’æ…£çš„ç’°å¢ƒå¾Œæ‰“åŒ…æˆ imageï¼Œä½†é–‹å§‹æœ‰å¾ˆå¤šç”¢å“è¦éƒ¨å±¬ä¹‹å¾Œï¼Œå°±æœƒé–‹å§‹å¯« DockerFile ä¾†å»ºç½®ï¼Œä¸€æ–¹é¢å¥½ç®¡ç†å¥½ç¶­è­·ï¼Œè£¡é ­æœ‰ä»€éº¼çœ‹ DockerFile å°±ä¸€ç›®ç­ç„¶ï¼Œä¸€æ–¹é¢ä¹Ÿæ›´æ–¹ä¾¿æˆ‘å€‘åŸ·è¡Œä¸€äº›å®¢åˆ¶åŒ–çš„è¡Œç‚º  

## Container
æƒ³åƒæˆæ˜¯è¼•é‡çš„ VMï¼Œè£é ­æœƒåŒ…å« OSï¼Œå†æ‰¿è¼‰ä½ çš„ç”¢å“ï¼Œæ¦‚å¿µä¹Ÿæœ‰é»åƒæ˜¯ä¸€å€‹æ‡‰ç”¨ç¨‹å¼ï¼Œç„¶è€Œç’°å¢ƒæ˜¯å®Œå…¨è¢«éš”é›¢çš„  

## Docker File
å¯ä»¥æƒ³æˆæ˜¯ä½ æƒ³è¦çš„ container çš„è¨­å®šæª”ï¼Œå¯ä»¥æŒ‡å®šä½ æƒ³åŸºæ–¼æŸå€‹ image ä¸Šé¢å»å»ºç½®ï¼Œä¹Ÿå¯åŠ å…¥æœ¬åœ°æª”æ¡ˆã€è¨­ç½®ç’°å¢ƒè®Šæ•¸ã€åŸ·è¡Œè…³æœ¬... ç­‰ç­‰ï¼Œå¯«å¥½çš„ DockerFile å¯ä»¥å»ºç½®æˆ image ç„¶å¾Œ run æˆ container  

```dockerfile
FROM node:latest    # åŸºæ–¼ node.js çš„ image å»å»ºç½®ï¼Œè£¡é¢æœƒå…§å»º node.js
WORKDIR /app        # æŠŠå·¥ä½œç’°å¢ƒæŒ‡å®šåœ¨ /app ä¸‹
ADD ./app /app      # æŠŠæœ¬åœ°ç›®éŒ„ ./app çš„å…§å®¹åŠ å…¥åˆ° /app ä¸‹
RUN npm install     # ç’°å¢ƒå»ºç½®æŒ‡ä»¤
ENV PORT=8080       # è¨­å®šç’°å¢ƒè®Šæ•¸
EXPOSE 8080         # é–‹æ”¾ 8080 port å°å¤–
CMD node index.js   # åŸ·è¡ŒæŒ‡ä»¤  (æ³¨æ„åªèƒ½æœ‰ä¸€è¡Œ CMD)
```

ä¸Šé¢å°±æ˜¯ä¸€å€‹ç°¡å–®åŒ…å« node.js çš„ DockerFile ç¯„ä¾‹ï¼Œå¯ä»¥çœ‹è¦‹é€™å€‹ DockerFile çš„è¨­å®šï¼Œæ¯”è¼ƒè¦æ³¨æ„çš„æ˜¯ï¼Œ`RUN` è·Ÿ `CMD` é€™å…©å€‹åœ°æ–¹æœƒæ¯”è¼ƒåŒªå¤·æ‰€æ€ä¸€é»ï¼Œæ„Ÿè¦ºåœ¨åšä¸€æ¨£çš„äº‹æƒ…  

äº‹å¯¦ä¸Šå‘¢ `RUN` çš„è¨­å®šæ˜¯åœ¨ DockerFile å»ºç«‹æˆ image çš„æ™‚å€™å°±åŸ·è¡Œäº†ï¼Œä¹Ÿå°±æ˜¯èªªä»–æ˜¯ç”¨ä¾†å»ºç½® image çš„ï¼Œè€Œä¸æ˜¯å¯¦éš›æœƒåœ¨ container ä¸ŠåŸ·è¡Œçš„  

å› æ­¤æœ€çµ‚å»ºç«‹å¥½çš„ image è£¡é¢å…¶å¯¦æ˜¯åŒ…å«æˆ‘å€‘çš„å°ˆæ¡ˆä»¥åŠ `npm install` å¾Œçš„ `node_module`ï¼Œè€Œæœ€å¾Œçš„ `CMD` å°±æ˜¯ image è¢« run èµ·ä¾†æˆä¸€å€‹ container ä¹‹å¾ŒæœƒåŸ·è¡Œçš„è…³æœ¬ï¼Œè€Œé€™é‚Šè¦æ³¨æ„å°±æ˜¯ `CMD` åªèƒ½è¨­å®šä¸€è¡ŒæŒ‡ä»¤ï¼Œè¨­å®šå¤šè¡Œçš„è©±ï¼ŒåªæœƒåŸ·è¡Œæœ€å¾Œä¸€è¡Œ  

DockerFile ä¹Ÿæœ‰ä¸€å€‹è¨­è¨ˆæ˜¯å¯ä»¥åŠ å…¥ä¸€å€‹ `.dockerignore` å°±åƒ git ä¸€æ¨£å¯ä»¥ç•¥éä¸€äº›ä¸æƒ³è¢«åŠ å…¥çš„æª”æ¡ˆ  

## åŸºæœ¬æµç¨‹æ“ä½œ
æ¥ä¸‹ä¾†è·‘ä¸€ä¸‹åŸºæœ¬çš„æµç¨‹ï¼ŒåŸºæ–¼ä¸Šé¢çš„ DockerFile å¾€ä¸‹èµ°ï¼Œå¯ä»¥å…ˆåœ¨ä¸Šé¢çš„ DockerFile åŒç›®éŒ„åº•ä¸‹å»ºä¸€å€‹ `app` çš„è³‡æ–™å¤¾ï¼Œç„¶å¾ŒåŠ å…¥é€™å…©å€‹æª”æ¡ˆ  

+ index.js  

```javascript
const express = require('express');
const app = express();

app.get('/', function(req, res) {
  res.send("<h1>hello docker</h1>");
});
const server = require('http').Server(app);
const port = process.env.PORT || 8080;

server.listen(port, function() {
  console.log("listening on port: " + port);
});
```

+ package.json  

```json
{
  "name": "hello-docker",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.17.1"
  }
}
```

ä¸Šé¢å¼„å¥½ä¹‹å¾Œï¼Œéµå…¥ä¸‹é¢æŒ‡ä»¤ï¼Œå¹«ä½ å»ºç½® image ä¸¦ä¸”å‘½å tag ç‚º hello-docker  

```shell
docker build . -t hello-docker
```

å¯ä»¥éµå…¥ä¸‹é¢æŒ‡ä»¤åˆ—å‡ºæ‰€æœ‰ image  

```shell
docker image ls
```

ç„¶å¾Œå†æŠŠæˆ‘å€‘çš„ image åŸ·è¡Œæˆæˆ‘å€‘çš„ container  

```shell
docker run -p 8000:8080 hello-docker
```

é€™é‚Šæœ‰å€‹è¦è¬›ä¸€ä¸‹çš„æ˜¯ `-p 8000:8080` çš„åƒæ•¸ï¼Œæ˜¯ç”¨ä¾†æŠŠé€™å€‹ container çš„ 8080 portï¼Œhost åˆ°æœ¬æ©Ÿçš„ 8000 portï¼Œè¦ç‰¹åˆ¥æ³¨æ„å‰å¾Œé †åºï¼Œå‰é¢æ˜¯æœ¬æ©Ÿçš„ portï¼Œè‡ªå·±è¢«é€™å€‹é›·åˆ°å¥½å¹¾æ¬¡  

æˆåŠŸè·‘èµ·ä¾†ä¹‹å¾Œå°±åˆ° [http://localhost:8000](http://localhost:8000){:target="_blank"} å»çœ‹çœ‹çµæœå§  

## å°çµ
åˆ°é€™é‚Šå¤§æ¦‚å° Docker æœ‰å€‹åŸºæœ¬æ¦‚å¿µï¼Œä¹‹å¾Œæœƒå†æ·±å…¥äº†è§£ä¸€ä¸‹ï¼ŒDocker æ¶æ§‹ä¸‹çš„å…¶ä»–çµ„ä»¶ï¼Œåƒæ˜¯ docker daemonã€docker network ...ï¼ŒDocker æœ‰å¾ˆå¤šæ±è¥¿éœ€è¦æ·±å…¥äº†è§£ï¼Œç„¶å¾Œé‚„æœ‰ K8s è¦ç©ï¼Œæ„Ÿè¦ºæ°¸é éƒ½å­¸ä¸å®Œé˜¿~ğŸ˜µ  

### å¸¸ç”¨æŒ‡ä»¤

+ `docker build . -t <imagename>`: å¾ Dockerfile å»ºç«‹ image ä¸¦è²¼ä¸Š tagname 
+ `docker pull <reponame>:<version>`: å¾ DockerHub ä¸Šæ‹‰ä¸‹æŒ‡å®šçš„ image 
+ `docker image ls`: åˆ—å‡ºæ‰€æœ‰ image
+ `docker container ls ` / `docker ps`: åˆ—å‡ºæ­£åœ¨é‹è¡Œçš„ container
+ `docker run -d <imagename> --name <containername>`: åœ¨èƒŒæ™¯åŸ·è¡Œ image æˆ container ä¸¦æŒ‡å®š container nameï¼Œä¸æŒ‡å®šæœƒéš¨æ©Ÿç”Ÿæˆ
+ `docker container start <containername>`: å•Ÿå‹• container 
+ `docker exec -it <containername> bash`: åŸ·è¡Œ container çš„ bash
+ `docker container stop <containername>`: åœæ­¢ container 
+ `docker container rm <containername>`: ç§»é™¤ container 